<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerenciar Espaços</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f7f7fb; }
header { background: #4f46e5; color: #fff; padding: 16px; }
nav { background: #fff; padding: 10px; border-bottom: 1px solid #ddd; }
nav a { margin-right: 12px; text-decoration: none; color: #4f46e5; }
.container { padding: 20px; max-width: 1200px; margin: 0 auto; }
h2 { margin-top: 0; }
.card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: bold; }
input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; background-color: #fff; border-radius: 6px; box-sizing: border-box; }
textarea { resize: vertical; min-height: 80px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
table th, table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
table th { background: #eee; }
button { background: #4f46e5; color: #fff; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px; }
button:hover { background: #4338ca; }
button.secondary { background: #e5e7eb; color: #111; }
button.secondary:hover { background: #d1d5db; }
button.danger { background: #ef4444; }
button.danger:hover { background: #dc2626; }
.status-ativo { color: #10b981; font-weight: bold; }
.status-inativo { color: #ef4444; font-weight: bold; }
.message { padding: 10px; border-radius: 6px; margin-bottom: 15px; }
.message.success { background: #d1fae5; color: #065f46; }
.message.error { background: #fee2e2; color: #991b1b; }
</style>
</head>
<body>
<header>
<h1>Seu Cantinho - Protótipo</h1>
</header>
<nav>
<a href="espacos.html">Gerenciar Espaços</a>
<a href="usuarios.html">Gerenciar Usuários</a>
<a href="reservas.html">Gerenciar Reservas</a>
<a href="pagamentos.html">Pagamentos</a>
</nav>

<div class="container">
<div id="messageBox"></div>

<div class="card">
<h2 id="formTitle">Cadastrar Novo Espaço</h2>
<form id="espacoForm">
<input type="hidden" id="espacoId" />
<div class="form-group">
<label for="nome">Nome*</label>
<input type="text" id="nome" required />
</div>
<div class="form-group">
<label for="descricao">Descrição*</label>
<textarea id="descricao" required></textarea>
</div>
<div class="form-group">
<label for="capacidade">Capacidade*</label>
<input type="number" id="capacidade" min="1" required />
</div>
<div class="form-group">
<label for="preco_por_hora">Preço por Hora (R$)*</label>
<input type="number" id="preco_por_hora" step="0.01" min="0" required />
</div>
<div class="form-group">
<label for="ativo">Status*</label>
<select id="ativo" required>
<option value="true">Ativo</option>
<option value="false">Inativo</option>
</select>
</div>
<button type="submit" id="submitBtn">Cadastrar</button>
<button type="button" class="secondary" onclick="cancelarEdicao()">Cancelar</button>
</form>
</div>

<div class="card">
<h2>Lista de Espaços</h2>
<button onclick="carregarEspacos()">Atualizar Lista</button>
<table>
<thead>
<tr>
<th>ID</th>
<th>Nome</th>
<th>Descrição</th>
<th>Capacidade</th>
<th>Preço/Hora</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="espacosTableBody">
<tr>
<td colspan="7" style="text-align: center;">Carregando...</td>
</tr>
</tbody>
</table>
</div>
</div>

<script>
const BROKER_URL = 'http://localhost:4000/espacos';
let editandoId = null;

document.addEventListener('DOMContentLoaded', () => {
  carregarEspacos();
});

function mostrarMensagem(mensagem, tipo = 'success') {
  const messageBox = document.getElementById('messageBox');
  messageBox.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
  setTimeout(() => { messageBox.innerHTML = ''; }, 4000);
}

async function carregarEspacos() {
  try {
    const response = await fetch(BROKER_URL);
    if (!response.ok) throw new Error('Erro ao carregar espaços');
    
    const espacos = await response.json();
    const tbody = document.getElementById('espacosTableBody');
    
    if (espacos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum espaço cadastrado</td></tr>';
      return;
    }
    
    tbody.innerHTML = espacos.map(espaco => `
      <tr>
        <td>${espaco.id}</td>
        <td>${espaco.nome}</td>
        <td>${espaco.descricao}</td>
        <td>${espaco.capacidade}</td>
        <td>R$ ${parseFloat(espaco.preco_por_hora).toFixed(2)}</td>
        <td class="${espaco.ativo ? 'status-ativo' : 'status-inativo'}">
          ${espaco.ativo ? 'Ativo' : 'Inativo'}
        </td>
        <td>
          <button onclick="editarEspaco(${espaco.id})">Editar</button>
          <button class="danger" onclick="deletarEspaco(${espaco.id})">Deletar</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    mostrarMensagem('Erro ao carregar espaços: ' + error.message, 'error');
  }
}

document.getElementById('espacoForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const dados = {
    nome: document.getElementById('nome').value,
    descricao: document.getElementById('descricao').value,
    capacidade: parseInt(document.getElementById('capacidade').value),
    preco_por_hora: parseFloat(document.getElementById('preco_por_hora').value),
    ativo: document.getElementById('ativo').value === 'true'
  };
  
  try {
    let response;
    if (editandoId) {
      response = await fetch(`${BROKER_URL}/${editandoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
      mostrarMensagem('Espaço atualizado com sucesso!');
    } else {
      response = await fetch(BROKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
      mostrarMensagem('Espaço cadastrado com sucesso!');
    }
    
    if (!response.ok) {
      const errData = await response.json().catch(() => null);
      const mensagem = errData?.erro || "Erro na operação";
      throw new Error(mensagem);
    }
    
    cancelarEdicao();
    carregarEspacos();
  } catch (error) {
    mostrarMensagem('Erro ao salvar espaço: ' + error.message, 'error');
  }
});

async function editarEspaco(id) {
  try {
    const response = await fetch(`${BROKER_URL}/${id}`);
    if (!response.ok) throw new Error('Erro ao buscar espaço');
    
    const espaco = await response.json();
    
    editandoId = id;
    document.getElementById('formTitle').textContent = 'Editar Espaço';
    document.getElementById('submitBtn').textContent = 'Atualizar';
    document.getElementById('nome').value = espaco.nome;
    document.getElementById('descricao').value = espaco.descricao;
    document.getElementById('capacidade').value = espaco.capacidade;
    document.getElementById('preco_por_hora').value = espaco.preco_por_hora;
    document.getElementById('ativo').value = espaco.ativo.toString();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (error) {
    mostrarMensagem('Erro ao carregar espaço: ' + error.message, 'error');
  }
}

function cancelarEdicao() {
  editandoId = null;
  document.getElementById('formTitle').textContent = 'Cadastrar Novo Espaço';
  document.getElementById('submitBtn').textContent = 'Cadastrar';
  document.getElementById('espacoForm').reset();
}

async function deletarEspaco(id) {
  if (!confirm('Tem certeza que deseja deletar este espaço?')) return;
  
  try {
    const response = await fetch(`${BROKER_URL}/${id}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Erro ao deletar espaço');
    
    mostrarMensagem('Espaço deletado com sucesso!');
    carregarEspacos();
  } catch (error) {
    mostrarMensagem('Erro ao deletar espaço: ' + error.message, 'error');
  }
}
</script>
</body>
</html>