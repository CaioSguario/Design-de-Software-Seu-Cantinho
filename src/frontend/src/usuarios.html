<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerenciar Usuários</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f7f7fb; }
header { background: #4f46e5; color: #fff; padding: 16px; }
nav { background: #fff; padding: 10px; border-bottom: 1px solid #ddd; }
nav a { margin-right: 12px; text-decoration: none; color: #4f46e5; }
.container { padding: 20px; max-width: 1400px; margin: 0 auto; }
h2 { margin-top: 0; }
.card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: bold; }
input, select { width: 100%; padding: 10px; border: 1px solid #ddd; background-color: #fff; border-radius: 6px; box-sizing: border-box; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; overflow-x: auto; display: block; }
table th, table td { border: 1px solid #ccc; padding: 8px; text-align: left; white-space: nowrap; }
table th { background: #eee; }
button { background: #4f46e5; color: #fff; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px; }
button:hover { background: #4338ca; }
button.secondary { background: #e5e7eb; color: #111; }
button.secondary:hover { background: #d1d5db; }
button.danger { background: #ef4444; }
button.danger:hover { background: #dc2626; }
.message { padding: 10px; border-radius: 6px; margin-bottom: 15px; }
.message.success { background: #d1fae5; color: #065f46; }
.message.error { background: #fee2e2; color: #991b1b; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
@media (max-width: 768px) {
  .form-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<header>
<h1>Seu Cantinho - Protótipo</h1>
</header>
<nav>
<a href="espacos.html">Gerenciar Espaços</a>
<a href="usuarios.html">Gerenciar Usuários</a>
<a href="reservas.html">Gerenciar Reservas</a>
<a href="pagamentos.html">Pagamentos</a>
</nav>

<div class="container">
<div id="messageBox"></div>

<div class="card">
<h2 id="formTitle">Cadastrar Novo Usuário</h2>
<form id="usuarioForm">
<input type="hidden" id="usuarioId" />
<div class="form-row">
<div class="form-group">
<label for="nome">Nome Completo*</label>
<input type="text" id="nome" required />
</div>
<div class="form-group">
<label for="cpf_cnpj">CPF/CNPJ*</label>
<input type="text" id="cpf_cnpj" placeholder="000.000.000-00 ou 00.000.000/0000-00" required />
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="email">E-mail*</label>
<input type="email" id="email" required />
</div>
<div class="form-group">
<label for="telefone">Telefone*</label>
<input type="tel" id="telefone" placeholder="(00) 00000-0000" required />
</div>
</div>
<div class="form-group">
<label for="endereco">Endereço*</label>
<input type="text" id="endereco" required />
</div>
<div class="form-group">
<label for="cargo">Cargo*</label>
<select id="cargo" required>
<option value="">Selecione...</option>
<option value="Administrador">Administrador</option>
<option value="Gerente">Gerente</option>
<option value="Atendente">Atendente</option>
<option value="Cliente">Cliente</option>
<option value="Fornecedor">Fornecedor</option>
</select>
</div>
<button type="submit" id="submitBtn">Cadastrar</button>
<button type="button" class="secondary" onclick="cancelarEdicao()">Cancelar</button>
</form>
</div>

<div class="card">
<h2>Lista de Usuários</h2>
<button onclick="carregarUsuarios()">Atualizar Lista</button>
<table>
<thead>
<tr>
<th>ID</th>
<th>Nome</th>
<th>CPF/CNPJ</th>
<th>E-mail</th>
<th>Telefone</th>
<th>Endereço</th>
<th>Cargo</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="usuariosTableBody">
<tr>
<td colspan="8" style="text-align: center;">Carregando...</td>
</tr>
</tbody>
</table>
</div>
</div>

<script>
const BROKER_URL = 'http://localhost:4000/usuarios';
let editandoId = null;

document.addEventListener('DOMContentLoaded', () => {
  carregarUsuarios();
  
  document.getElementById('cpf_cnpj').addEventListener('input', aplicarMascaraCpfCnpj);
  document.getElementById('telefone').addEventListener('input', aplicarMascaraTelefone);
});


function mostrarMensagem(mensagem, tipo = 'success') {
  const messageBox = document.getElementById('messageBox');
  messageBox.innerHTML = `<div class="message ${tipo}">${mensagem}</div>`;
  setTimeout(() => { messageBox.innerHTML = ''; }, 4000);
}


function aplicarMascaraCpfCnpj(e) {
  let valor = e.target.value.replace(/\D/g, '');
  
  if (valor.length <= 11) {
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  } else {
    valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
    valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
    valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
  }
  
  e.target.value = valor;
}


function aplicarMascaraTelefone(e) {
  let valor = e.target.value.replace(/\D/g, '');
  
  if (valor.length <= 10) {
    valor = valor.replace(/^(\d{2})(\d)/, '($1) $2');
    valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
  } else {
    valor = valor.replace(/^(\d{2})(\d)/, '($1) $2');
    valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
  }
  
  e.target.value = valor;
}

async function carregarUsuarios() {
  try {
    const response = await fetch(BROKER_URL);
    if (!response.ok) throw new Error('Erro ao carregar usuários');
    
    const usuarios = await response.json();
    const tbody = document.getElementById('usuariosTableBody');
    
    if (usuarios.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhum usuário cadastrado</td></tr>';
      return;
    }
    
    tbody.innerHTML = usuarios.map(usuario => `
      <tr>
        <td>${usuario.id}</td>
        <td>${usuario.nome}</td>
        <td>${usuario.cpf_cnpj}</td>
        <td>${usuario.email}</td>
        <td>${usuario.telefone}</td>
        <td>${usuario.endereco}</td>
        <td>${usuario.cargo}</td>
        <td>
          <button onclick="editarUsuario(${usuario.id})">Editar</button>
          <button class="danger" onclick="deletarUsuario(${usuario.id})">Deletar</button>
        </td>
      </tr>
    `).join('');
  } catch (error) {
    mostrarMensagem('Erro ao carregar usuários: ' + error.message, 'error');
  }
}

document.getElementById('usuarioForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const dados = {
    nome: document.getElementById('nome').value,
    cpf_cnpj: document.getElementById('cpf_cnpj').value,
    email: document.getElementById('email').value,
    telefone: document.getElementById('telefone').value,
    endereco: document.getElementById('endereco').value,
    cargo: document.getElementById('cargo').value
  };
  
  try {
    let response;
    if (editandoId) {
      response = await fetch(`${BROKER_URL}/${editandoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
      mostrarMensagem('Usuário atualizado com sucesso!');
    } else {
      response = await fetch(BROKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
      mostrarMensagem('Usuário cadastrado com sucesso!');
    }
    
    if (!response.ok) {
      const errData = await response.json().catch(() => null);
      const mensagem = errData?.erro || "Erro na operação";
      throw new Error(mensagem);
    }
    
    cancelarEdicao();
    carregarUsuarios();
  } catch (error) {
    mostrarMensagem('Erro ao salvar usuário: ' + error.message, 'error');
  }
});


async function editarUsuario(id) {
  try {
    const response = await fetch(`${BROKER_URL}/${id}`);
    if (!response.ok) throw new Error('Erro ao buscar usuário');
    
    const usuario = await response.json();
    
    editandoId = id;
    document.getElementById('formTitle').textContent = 'Editar Usuário';
    document.getElementById('submitBtn').textContent = 'Atualizar';
    document.getElementById('nome').value = usuario.nome;
    document.getElementById('cpf_cnpj').value = usuario.cpf_cnpj;
    document.getElementById('email').value = usuario.email;
    document.getElementById('telefone').value = usuario.telefone;
    document.getElementById('endereco').value = usuario.endereco;
    document.getElementById('cargo').value = usuario.cargo;
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (error) {
    mostrarMensagem('Erro ao carregar usuário: ' + error.message, 'error');
  }
}


function cancelarEdicao() {
  editandoId = null;
  document.getElementById('formTitle').textContent = 'Cadastrar Novo Usuário';
  document.getElementById('submitBtn').textContent = 'Cadastrar';
  document.getElementById('usuarioForm').reset();
}


async function deletarUsuario(id) {
  if (!confirm('Tem certeza que deseja deletar este usuário?')) return;
  
  try {
    const response = await fetch(`${BROKER_URL}/${id}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Erro ao deletar usuário');
    
    mostrarMensagem('Usuário deletado com sucesso!');
    carregarUsuarios();
  } catch (error) {
    mostrarMensagem('Erro ao deletar usuário: ' + error.message, 'error');
  }
}
</script>
</body>
</html>